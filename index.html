<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEPYBET PRESTIGE | Institutional Intelligence</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        vault: {
                            bg: '#0a0c10',
                            card: '#11141d',
                            accent: '#3b82f6',
                            success: '#10b981',
                            error: '#f43f5e',
                            border: 'rgba(255, 255, 255, 0.08)',
                            text: '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --sidebar-width: 280px;
        }

        body { 
            background-color: #0a0c10;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Alineación Perfecta */
        .grid-master {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: 100vh;
        }

        .sidebar {
            background-color: #0d1117;
            border-right: 1px solid var(--vault-border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            overflow-y: auto;
            background: radial-gradient(circle at top right, #111827, #0a0c10);
        }

        /* Componentes Premium */
        .executive-card {
            background: rgba(17, 20, 29, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--vault-border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .executive-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #94a3b8;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: white;
        }

        .nav-item.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        .money-font {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.05em;
        }

        /* Inputs y Selects Profesionales */
        input, select {
            background: #0d1117 !important;
            border: 1px solid var(--vault-border) !important;
            border-radius: 8px;
            padding: 0.625rem 1rem;
            color: white !important;
            font-size: 0.875rem;
        }

        input:focus {
            border-color: #3b82f6 !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Reporte de Auditoría Pro */
        .audit-sheet {
            background: white;
            color: #1e293b;
            padding: 4rem;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 1000px;
            margin: 0 auto;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .loading-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

    <!-- PORTAL DE ACCESO SEGURO -->
    <div id="login-screen" class="fixed inset-0 z-[1000] bg-vault-bg flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <div class="w-16 h-16 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-white uppercase">Prestige Gateway</h1>
                <p class="text-slate-500 text-sm mt-2">Ingrese sus credenciales operativas</p>
            </div>
            
            <div class="space-y-4 bg-vault-card p-8 rounded-2xl border border-vault-border shadow-2xl">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Identificador</label>
                    <input type="text" id="auth-user" class="w-full" placeholder="admin">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Contraseña</label>
                    <input type="password" id="auth-pass" class="w-full" placeholder="admin">
                </div>
                <button onclick="app.login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all transform active:scale-95 shadow-lg shadow-blue-900/20">Iniciar Sesión</button>
                <p id="login-error" class="text-vault-error text-[10px] font-bold text-center hidden uppercase tracking-wider">Acceso Denegado</p>
            </div>
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div id="app-shell" class="hidden grid-master opacity-0 transition-opacity duration-700">
        
        <!-- SIDEBAR IZQUIERDO -->
        <aside class="sidebar no-print">
            <div class="flex items-center gap-3 mb-12">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white shadow-lg">S</div>
                <h2 class="text-lg font-bold tracking-tighter text-white">SEPYBET <span class="text-blue-500">PRESTIGE</span></h2>
            </div>
            
            <nav class="flex-1 space-y-1">
                <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-4 px-4">Menu Principal</p>
                <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" stroke-width="2"/></svg>
                    <span>Dashboard</span>
                </button>
                <button onclick="app.nav('import')" id="nav-import" class="nav-item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" stroke-width="2"/></svg>
                    <span>Carga de Datos</span>
                </button>
                <button onclick="app.nav('agents')" id="nav-agents" class="nav-item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2"/></svg>
                    <span>Gestión de Red</span>
                </button>
                <button onclick="app.nav('audit')" id="nav-audit" class="nav-item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2"/></svg>
                    <span>Auditoría Final</span>
                </button>
            </nav>

            <div class="mt-auto p-4 bg-white/5 rounded-xl border border-vault-border">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center font-bold text-xs">A</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[11px] font-bold text-white uppercase truncate tracking-tight">Admin Principal</p>
                        <button onclick="location.reload()" class="text-[10px] text-vault-error font-bold hover:underline">Log Out</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content flex flex-col h-screen">
            
            <!-- HEADER SUPERIOR -->
            <header class="h-20 flex items-center justify-between px-10 border-b border-vault-border no-print">
                <div class="flex items-center gap-4">
                    <h2 id="view-title" class="text-xl font-bold text-white tracking-tight">Dashboard</h2>
                    <span class="px-3 py-1 bg-blue-600/10 text-blue-500 text-[10px] font-bold rounded-full border border-blue-500/20 uppercase tracking-widest">En Línea</span>
                </div>
                
                <div id="header-tools" class="flex items-center gap-4">
                    <!-- Dinámico -->
                </div>
            </header>

            <div id="viewport" class="flex-1 overflow-y-auto p-10 no-scrollbar">

                <!-- VISTA: DASHBOARD -->
                <div id="view-dashboard" class="view space-y-8 animate-in fade-in duration-500">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="executive-card">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-3">Volumen Depósitos</p>
                            <h3 id="stat-in" class="text-2xl font-bold money-font text-white">$0.00</h3>
                        </div>
                        <div class="executive-card border-l-4 border-l-vault-error">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-3">Volumen Retiros</p>
                            <h3 id="stat-out" class="text-2xl font-bold money-font text-slate-400">-$0.00</h3>
                        </div>
                        <div class="executive-card bg-blue-600/10 border-blue-600/20 border-l-4 border-l-blue-600">
                            <p class="text-[10px] font-bold text-blue-500 uppercase tracking-[0.2em] mb-3">GGR Neto Global</p>
                            <h3 id="stat-ggr" class="text-2xl font-bold money-font text-white">$0.00</h3>
                        </div>
                        <div class="executive-card border-l-4 border-l-vault-success">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-3">Liquidación Agentes</p>
                            <h3 id="stat-fees" class="text-2xl font-bold money-font text-vault-success">$0.00</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-8">
                        <div class="col-span-12 lg:col-span-8 executive-card h-[450px] flex flex-col">
                            <h4 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-8 italic">Distribución de Activos por Nodo</h4>
                            <div class="flex-1 min-h-0">
                                <canvas id="main-chart"></canvas>
                            </div>
                        </div>
                        <div class="col-span-12 lg:col-span-4 executive-card flex flex-col">
                            <h4 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-6 italic text-center">Protocolo de Operaciones</h4>
                            <div id="log-list" class="flex-1 space-y-3 overflow-y-auto pr-2 no-scrollbar opacity-60"></div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: IMPORTAR -->
                <div id="view-import" class="view hidden h-full flex items-center justify-center animate-in zoom-in duration-500">
                    <div class="max-w-xl w-full executive-card p-16 text-center border-2 border-dashed border-slate-700">
                        <div class="w-24 h-24 bg-blue-600/10 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-8">
                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" stroke-width="1.5"/></svg>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Importar Inteligencia de Datos</h3>
                        <p class="text-slate-500 text-sm mb-10 max-w-xs mx-auto">Sincronice su archivo .xlsx para habilitar la terminal de auditoría y liquidación.</p>
                        
                        <label class="group relative cursor-pointer inline-block">
                            <input type="file" id="file-input" class="hidden" onchange="app.handleFile(this.files[0])">
                            <span id="file-label" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-xl transition-all shadow-xl shadow-blue-900/20 inline-block">Seleccionar Master Excel</span>
                        </label>
                    </div>
                </div>

                <!-- VISTA: AGENTES -->
                <div id="view-agents" class="view hidden space-y-8 animate-in slide-in-from-right duration-500">
                    <div class="grid grid-cols-12 gap-10">
                        <div class="col-span-12 lg:col-span-4 space-y-6">
                            <div class="executive-card space-y-8">
                                <h3 class="text-sm font-bold text-white uppercase tracking-widest italic border-l-4 border-blue-600 pl-4">Anclar Nodo Maestro</h3>
                                <div class="space-y-6">
                                    <div class="space-y-2">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Nombre Operativo</label>
                                        <input type="text" id="node-name" class="w-full uppercase font-bold" placeholder="EJ: DELTA_STATION">
                                    </div>
                                    <div class="space-y-6">
                                        <div class="flex justify-between items-center">
                                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Fee de Liquidación</label>
                                            <span id="fee-disp" class="text-2xl font-bold text-blue-500 money-font">20%</span>
                                        </div>
                                        <input type="range" id="node-fee" min="1" max="50" value="20" oninput="document.getElementById('fee-disp').innerText = this.value + '%'" class="w-full accent-blue-600 h-1 bg-slate-800 rounded-full appearance-none">
                                    </div>
                                    <button onclick="app.addAgent()" class="w-full bg-white hover:bg-blue-600 hover:text-white text-black font-black py-4 rounded-xl transition-all uppercase tracking-widest text-[11px]">Establecer Conexión</button>
                                </div>
                            </div>
                            <div id="agent-list" class="space-y-3 max-h-[400px] overflow-y-auto no-scrollbar"></div>
                        </div>

                        <div class="col-span-12 lg:col-span-8 executive-card flex flex-col h-[750px] overflow-hidden">
                            <div class="p-6 bg-white/5 border-b border-vault-border flex justify-between items-center">
                                <h3 class="text-sm font-bold text-white uppercase tracking-widest">Mapeo de Terminales de Usuario</h3>
                                <input type="text" id="user-search" oninput="app.renderAgents()" placeholder="Trace ID..." class="w-72 bg-transparent text-xs font-bold uppercase tracking-widest">
                            </div>
                            <div id="user-grid" class="flex-1 overflow-y-auto p-8 grid grid-cols-1 md:grid-cols-2 gap-4 content-start no-scrollbar"></div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: AUDITORÍA -->
                <div id="view-audit" class="view hidden">
                    <div id="audit-sheet" class="audit-sheet animate-in slide-in-from-bottom duration-1000">
                        <!-- Header Reporte -->
                        <div class="flex justify-between items-start border-b-2 border-slate-900/10 pb-10 mb-12">
                            <div>
                                <h1 class="text-4xl font-black tracking-tighter text-slate-900 uppercase">Statement of Earnings</h1>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-[0.4em] mt-2">Sepybet Institutional Prestige Protocol v3.0</p>
                            </div>
                            <div class="text-right space-y-4">
                                <div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Reference ID</p>
                                    <p id="audit-id" class="text-xs font-mono font-bold text-slate-900 uppercase"></p>
                                </div>
                                <p id="audit-date" class="text-[10px] text-slate-400 font-bold uppercase"></p>
                            </div>
                        </div>

                        <!-- Dashboard Auditoría -->
                        <div id="audit-summary-grid" class="grid grid-cols-3 gap-8 mb-20"></div>

                        <!-- Contenido Principal -->
                        <div id="audit-body" class="space-y-24"></div>

                        <!-- Footer -->
                        <div class="mt-40 pt-16 border-t-2 border-slate-100">
                            <div class="grid grid-cols-3 gap-20">
                                <div class="text-center italic">
                                    <div class="h-[1px] bg-slate-200 mb-2"></div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Sello Digital Corporativo</p>
                                </div>
                                <div class="flex flex-col items-center justify-center opacity-10">
                                    <div class="w-16 h-16 bg-black rounded-full"></div>
                                </div>
                                <div class="text-center italic">
                                    <div class="h-[1px] bg-slate-200 mb-2"></div>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Validación de Auditoría</p>
                                </div>
                            </div>
                            <p class="mt-20 text-center text-[10px] text-slate-300 font-bold uppercase tracking-[1em]">Privado • Confidencial</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        const app = {
            state: {
                agents: [],
                rawData: [],
                adjustments: {},
                currView: 'login',
                charts: {},
                isLogged: false
            },

            init() {
                const data = localStorage.getItem('sepy_prestige_v3');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.state.agents = parsed.agents || [];
                    this.state.adjustments = parsed.adjustments || {};
                }
            },

            login() {
                const u = document.getElementById('auth-user').value.toLowerCase();
                const p = document.getElementById('auth-pass').value;
                if (u === 'admin' && p === 'admin') {
                    this.state.isLogged = true;
                    document.getElementById('login-screen').style.display = 'none';
                    const shell = document.getElementById('app-shell');
                    shell.classList.remove('hidden');
                    setTimeout(() => shell.style.opacity = '1', 50);
                    this.nav('import');
                    this.log("Handshake de seguridad validado.", "success");
                } else {
                    const err = document.getElementById('login-error');
                    err.classList.remove('hidden');
                    setTimeout(() => err.classList.add('hidden'), 2000);
                }
            },

            nav(id) {
                if (!this.state.isLogged) return;
                this.state.currView = id;
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                document.getElementById('view-' + id).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                document.getElementById('nav-' + id).classList.add('active');

                const titles = { dashboard: 'Resumen Maestro', import: 'Terminal de Inteligencia', agents: 'Arquitectura de Red', audit: 'Informe de Liquidación' };
                document.getElementById('view-title').innerText = titles[id];

                const tools = document.getElementById('header-tools');
                tools.innerHTML = '';
                if (id === 'audit') {
                    tools.innerHTML = `
                        <select id="h-filter" onchange="app.renderAudit()" class="text-[10px] font-black uppercase w-64"></select>
                        <button onclick="app.exportPDF()" class="bg-white text-black font-black px-6 py-2 rounded-lg text-[10px] uppercase shadow-xl hover:bg-blue-600 hover:text-white transition-all">Generar Statement PDF</button>
                    `;
                }

                if (id === 'dashboard') this.renderDashboard();
                if (id === 'agents') this.renderAgents();
                if (id === 'audit') this.renderAudit();
            },

            log(msg, type = 'info') {
                const list = document.getElementById('log-list');
                if (!list) return;
                const time = new Date().toLocaleTimeString('es-EC', { hour12: false });
                const color = type === 'success' ? 'text-vault-success' : (type === 'error' ? 'text-vault-error' : 'text-slate-500');
                const div = document.createElement('div');
                div.className = "flex gap-4 border-b border-white/5 pb-2 text-[10px] font-mono";
                div.innerHTML = `<span class="opacity-30 italic">${time}</span><span class="${color} font-bold uppercase tracking-tighter">${msg}</span>`;
                list.prepend(div);
            },

            save() {
                localStorage.setItem('sepy_prestige_v3', JSON.stringify({
                    agents: this.state.agents,
                    adjustments: this.state.adjustments
                }));
            },

            handleFile(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    this.state.rawData = json;
                    document.getElementById('file-label').innerText = `Matrix Ready (${json.length} IDs)`;
                    this.log(`Procesados ${json.length} registros operativos.`, "success");
                    // AUTO-NAVIGATE
                    setTimeout(() => this.nav('dashboard'), 600);
                };
                reader.readAsArrayBuffer(file);
            },

            getBalances() {
                const b = {};
                this.state.rawData.forEach(row => {
                    const u = row['Nombre de jugador/agente'] || row.Usuario || row.Player || 'X-ID';
                    const a = Math.abs(parseFloat(row.Monto || row.Amount || 0));
                    const ty = String(row['Tipo de operación'] || row.Type || '').toLowerCase();
                    const st = String(row['Estado'] || row.Status || '').toLowerCase();

                    if (u === 'X-ID' || st !== 'processed') return;
                    if (!b[u]) b[u] = { in: 0, out: 0 };

                    if (ty.includes('deposit') || ty.includes('ingreso')) b[u].in += a;
                    else if (ty.includes('withdrawal') || ty.includes('retiro')) b[u].out += a;
                });
                return b;
            },

            calculateMatrix() {
                const bal = this.getBalances();
                return this.state.agents.map(ag => {
                    let ti = 0, to = 0, ta = 0;
                    const entities = ag.players.map(p => {
                        const s = bal[p] || { in: 0, out: 0 };
                        const adj = parseFloat(this.state.adjustments[p] || 0);
                        const net = (s.in - s.out) - adj;
                        ti += s.in; to += s.out; ta += adj;
                        return { id: p, in: s.in, out: s.out, adj, net };
                    });
                    const ggr = (ti - to) - ta;
                    const feeAmt = ggr > 0 ? (ggr * (ag.fee / 100)) : 0;
                    return { ...ag, entities, ti, to, ta, ggr, feeAmt, health: ti > 0 ? ((ggr / ti) * 100).toFixed(1) : 0 };
                });
            },

            renderDashboard() {
                const raw = this.getBalances();
                const matrix = this.calculateMatrix();
                
                const tIn = Object.values(raw).reduce((a, b) => a + b.in, 0);
                const tOut = Object.values(raw).reduce((a, b) => a + b.out, 0);
                const tGGR = matrix.reduce((a, b) => a + b.ggr, 0);
                const tFee = matrix.reduce((a, b) => a + b.feeAmt, 0);

                document.getElementById('stat-in').innerText = `$${tIn.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;
                document.getElementById('stat-out').innerText = `-$${tOut.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;
                document.getElementById('stat-ggr').innerText = `$${tGGR.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;
                document.getElementById('stat-fees').innerText = `$${tFee.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;

                if (this.state.charts.main) this.state.charts.main.destroy();
                const ctx = document.getElementById('main-chart').getContext('2d');
                this.state.charts.main = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: matrix.map(x => x.name),
                        datasets: [{
                            label: 'GGR Nivelado',
                            data: matrix.map(x => x.ggr),
                            backgroundColor: '#3b82f6',
                            borderRadius: 12,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#475569', font: { family: 'JetBrains Mono', size: 10 } } },
                            x: { grid: { display: false }, ticks: { color: '#475569', font: { weight: 'bold', size: 9 } } }
                        }
                    }
                });
            },

            addAgent() {
                const name = document.getElementById('node-name').value.trim().toUpperCase();
                const fee = parseInt(document.getElementById('node-fee').value);
                if (!name || this.state.agents.some(x => x.name === name)) return;
                this.state.agents.push({ name, fee, players: [] });
                document.getElementById('node-name').value = '';
                this.save();
                this.renderAgents();
                this.log(`Establecido canal de liquidación para ${name}.`, "success");
            },

            removeAgent(idx) {
                this.state.agents.splice(idx, 1);
                this.save();
                this.renderAgents();
            },

            linkPlayer(idx, pid) {
                this.state.agents.forEach(a => a.players = a.players.filter(x => x !== pid));
                this.state.agents[idx].players.push(pid);
                this.save();
                this.renderAgents();
            },

            unlinkPlayer(pid) {
                this.state.agents.forEach(a => a.players = a.players.filter(x => x !== pid));
                this.save();
                this.renderAgents();
            },

            renderAgents() {
                const raw = this.getBalances();
                const q = document.getElementById('user-search').value.toUpperCase();
                const players = Object.keys(raw).filter(id => id.includes(q));

                document.getElementById('agent-list').innerHTML = this.state.agents.map((a, i) => `
                    <div class="executive-card flex justify-between items-center border-l-4 border-l-blue-600 p-6">
                        <div>
                            <p class="text-xs font-black text-white uppercase tracking-widest">${a.name}</p>
                            <p class="text-[10px] text-slate-500 font-bold uppercase mt-1">${a.fee}% Fee • ${a.players.length} Terminales</p>
                        </div>
                        <button onclick="app.removeAgent(${i})" class="text-slate-600 hover:text-vault-error transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7" stroke-width="2.5"/></svg>
                        </button>
                    </div>
                `).join('');

                document.getElementById('user-grid').innerHTML = players.map(pid => {
                    const assigned = this.state.agents.find(a => a.players.includes(pid));
                    return `
                        <div class="executive-card flex flex-col gap-4 ${assigned ? 'bg-blue-600/5 border-blue-600/30' : ''}">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-slate-800 border border-slate-700 flex items-center justify-center font-black text-slate-500 text-sm italic">${pid.charAt(0)}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-black text-white truncate uppercase tracking-tighter leading-none mb-1">${pid}</p>
                                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">${assigned ? 'Nodo: ' + assigned.name : 'Terminal Autónoma'}</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                ${assigned ? `<button onclick="app.unlinkPlayer('${pid}')" class="px-3 py-1.5 bg-vault-error/10 text-vault-error rounded-lg text-[9px] font-bold uppercase tracking-widest hover:bg-vault-error hover:text-white transition-all">Sever</button>` : ''}
                                ${this.state.agents.map((a, i) => assigned?.name !== a.name ? `<button onclick="app.linkPlayer(${i}, '${pid}')" class="px-3 py-1.5 bg-slate-800 text-slate-400 rounded-lg text-[9px] font-bold uppercase hover:bg-blue-600 hover:text-white transition-all">${a.name}</button>` : '').join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updateAdj(pid, val) {
                this.state.adjustments[pid] = val;
                this.save();
                this.renderAudit();
            },

            renderAudit() {
                const matrix = this.calculateMatrix();
                const filter = document.getElementById('h-filter')?.value || 'ALL';
                const filterSelect = document.getElementById('h-filter');
                if (filterSelect) {
                    const last = filterSelect.value;
                    filterSelect.innerHTML = `<option value="ALL">CONSOLIDADO GLOBAL DE RED</option>` + this.state.agents.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
                    filterSelect.value = last || 'ALL';
                }

                const filtered = filter === 'ALL' ? matrix : matrix.filter(a => a.name === filter);
                const gTi = matrix.reduce((a, b) => a + b.ti, 0);
                const gGr = matrix.reduce((a, b) => a + b.ggr, 0);
                const gFa = matrix.reduce((a, b) => a + b.feeAmt, 0);

                document.getElementById('audit-id').innerText = 'PRSTG-X' + Math.random().toString(36).substr(2, 8).toUpperCase();
                document.getElementById('audit-date').innerText = new Date().toLocaleString('es-EC', { dateStyle: 'full', timeStyle: 'short' });

                document.getElementById('audit-summary-grid').innerHTML = `
                    <div class="p-10 border-2 border-slate-100 rounded-3xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.4em] mb-4">Total Liquidez Entrada</p>
                        <p class="text-3xl font-black money-font text-slate-900">$${gTi.toLocaleString('es-EC', {minimumFractionDigits: 2})}</p>
                    </div>
                    <div class="p-10 bg-slate-900 rounded-3xl text-white shadow-2xl">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.4em] mb-4 italic">Utilidad Neta Prestige</p>
                        <p class="text-4xl font-black money-font text-white">$${(gGr - gFa).toLocaleString('es-EC', {minimumFractionDigits: 2})}</p>
                    </div>
                    <div class="p-10 border-2 border-slate-100 rounded-3xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.4em] mb-4 italic">Provisionado Agentes</p>
                        <p class="text-3xl font-black money-font text-blue-600">$${gFa.toLocaleString('es-EC', {minimumFractionDigits: 2})}</p>
                    </div>
                `;

                document.getElementById('audit-body').innerHTML = filtered.map(a => `
                    <div class="space-y-12">
                        <div class="flex justify-between items-end border-b-4 border-slate-900 pb-8">
                            <div>
                                <h3 class="text-6xl font-black text-slate-900 italic tracking-tighter uppercase leading-none">${a.name}</h3>
                                <div class="flex items-center gap-6 mt-6">
                                    <span class="px-4 py-1 bg-slate-900 text-white text-[10px] font-black rounded uppercase tracking-widest">Efficiency: ${a.health}%</span>
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] italic">Station Verified • Node Active</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 italic font-light">Settlement Amount (${a.fee}%)</p>
                                <p class="text-7xl font-black money-font text-slate-900 tracking-tighter">$${a.feeAmt.toLocaleString('es-EC', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>

                        <div class="overflow-hidden border-2 border-slate-900 rounded-3xl shadow-sm">
                            <table class="w-full text-left">
                                <thead class="bg-slate-900 text-[11px] font-bold text-white uppercase tracking-widest">
                                    <tr>
                                        <th class="py-6 px-8">Terminal ID</th>
                                        <th class="py-6 px-4 text-center">Inflow (+)</th>
                                        <th class="py-6 px-4 text-center">Outflow (-)</th>
                                        <th class="py-6 px-4 text-center">Audit Adj.</th>
                                        <th class="py-6 px-8 text-right font-black">Net Value</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y-2 divide-slate-100 text-sm">
                                    ${a.entities.map(e => `
                                        <tr class="hover:bg-slate-50 transition-colors">
                                            <td class="py-6 px-8 font-black text-slate-900 uppercase tracking-tighter leading-none text-base italic">${e.id}</td>
                                            <td class="py-6 px-4 text-center money-font text-slate-500">$${e.in.toLocaleString()}</td>
                                            <td class="py-6 px-4 text-center money-font text-slate-400">-$${e.out.toLocaleString()}</td>
                                            <td class="py-6 px-4 text-center no-print">
                                                <input type="number" oninput="app.updateAdj('${e.id}', this.value)" value="${this.state.adjustments[e.id] || ''}" class="w-28 text-center font-black text-blue-600 bg-slate-100 border-none outline-none rounded">
                                            </td>
                                            <td class="py-6 px-8 text-right font-black money-font text-slate-900 text-2xl tracking-tighter">$${e.net.toLocaleString('es-EC', {minimumFractionDigits: 2})}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot class="bg-slate-100 text-slate-900 font-bold">
                                    <tr>
                                        <td colspan="4" class="py-8 px-8 text-right text-[12px] uppercase tracking-[0.5em] opacity-40 italic">Aggregate Node Yield:</td>
                                        <td class="py-8 px-8 text-right text-6xl money-font tracking-tighter leading-none italic">$${a.ggr.toLocaleString('es-EC', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `).join('');
            },

            async exportPDF() {
                const sheet = document.getElementById('audit-sheet');
                document.querySelectorAll('.no-print').forEach(el => el.style.opacity = '0');
                const canvas = await html2canvas(sheet, { scale: 3, backgroundColor: '#ffffff', useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const w = pdf.internal.pageSize.getWidth();
                const h = (canvas.height * w) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, w, h);
                pdf.save(`SEPYBET_PRESTIGE_STATEMENT_${Date.now()}.pdf`);
                document.querySelectorAll('.no-print').forEach(el => el.style.opacity = '1');
                this.log("Reporte exportado con sello institucional.", "success");
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
