<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEPYBET PRESTIGE | Mobile-Ready Finance</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        prestige: {
                            bg: '#0a0c10',
                            card: '#11141d',
                            accent: '#3b82f6',
                            emerald: '#10b981',
                            border: 'rgba(255, 255, 255, 0.08)',
                            error: '#f43f5e'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0a0c10;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        .premium-card {
            background: rgba(17, 20, 29, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid var(--prestige-border);
            border-radius: 20px;
        }

        .nav-active {
            color: #3b82f6 !important;
            position: relative;
        }

        .nav-active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #3b82f6;
            border-radius: 50%;
            box-shadow: 0 0 8px #3b82f6;
        }

        @media (min-width: 1024px) {
            .nav-active::after {
                left: 0;
                bottom: auto;
                top: 50%;
                transform: translateY(-50%);
                width: 3px;
                height: 20px;
                border-radius: 0 4px 4px 0;
            }
        }

        .money { font-family: 'JetBrains Mono', monospace; font-variant-numeric: tabular-nums; }

        input, select {
            background: #0d1117 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 12px;
            color: white !important;
            font-size: 16px !important; /* Evita zoom automático en iOS */
        }

        /* Responsive Audit Sheet */
        .audit-container {
            background: white;
            color: #0f172a;
            border-radius: 12px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- LOGIN -->
    <div id="login-gate" class="fixed inset-0 z-[2000] bg-prestige-bg flex items-center justify-center p-6">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <h1 class="text-2xl font-black text-white uppercase italic tracking-tighter">TITAN PRESTIGE</h1>
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-[0.3em] mt-2">Mobile Access Gateway</p>
            </div>
            
            <div class="bg-prestige-card p-8 rounded-3xl border border-white/5 shadow-2xl space-y-4">
                <input type="text" id="auth-u" class="w-full text-center py-4 font-bold uppercase tracking-widest" placeholder="admin">
                <input type="password" id="auth-p" class="w-full text-center py-4 font-bold tracking-widest" placeholder="••••">
                <button onclick="app.authenticate()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl transition-all shadow-lg shadow-blue-900/20 uppercase text-xs tracking-widest">Entrar</button>
                <p id="auth-error" class="text-prestige-error text-[10px] font-bold text-center hidden uppercase">Credenciales Inválidas</p>
            </div>
        </div>
    </div>

    <!-- APP SHELL -->
    <div id="app-shell" class="hidden flex-1 flex flex-col lg:flex-row overflow-hidden opacity-0 transition-opacity duration-700">
        
        <!-- SIDEBAR (Desktop) / TOP NAV (Mobile) -->
        <aside class="lg:w-72 lg:h-full bg-slate-950 border-r border-white/5 flex flex-col no-print z-[100]">
            <div class="p-6 hidden lg:flex items-center gap-3 border-b border-white/5">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white shadow-lg italic">T</div>
                <h2 class="text-lg font-bold tracking-tighter text-white uppercase italic">Prestige</h2>
            </div>
            
            <nav class="hidden lg:flex flex-col flex-1 p-4 space-y-1">
                <button onclick="app.nav('dash')" id="m-dash" class="flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-slate-400 hover:text-white transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" stroke-width="2"/></svg> Dashboard</button>
                <button onclick="app.nav('sync')" id="m-sync" class="flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-slate-400 hover:text-white transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" stroke-width="2"/></svg> Importar</button>
                <button onclick="app.nav('net')" id="m-net" class="flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-slate-400 hover:text-white transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2"/></svg> Agentes</button>
                <button onclick="app.nav('audit')" id="m-audit" class="flex items-center gap-3 p-4 rounded-xl text-sm font-bold text-slate-400 hover:text-white transition-all"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2"/></svg> Auditoría</button>
            </nav>

            <!-- Bottom Nav (Mobile Only) -->
            <nav class="lg:hidden fixed bottom-0 left-0 right-0 h-20 bg-slate-950 border-t border-white/5 flex items-center justify-around px-4 z-[1000] no-print">
                <button onclick="app.nav('dash')" id="mb-dash" class="flex flex-col items-center gap-1 text-slate-500 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" stroke-width="2"/></svg><span class="text-[9px] font-bold uppercase tracking-widest">Panel</span></button>
                <button onclick="app.nav('sync')" id="mb-sync" class="flex flex-col items-center gap-1 text-slate-500 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" stroke-width="2"/></svg><span class="text-[9px] font-bold uppercase tracking-widest">Carga</span></button>
                <button onclick="app.nav('net')" id="mb-net" class="flex flex-col items-center gap-1 text-slate-500 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2"/></svg><span class="text-[9px] font-bold uppercase tracking-widest">Red</span></button>
                <button onclick="app.nav('audit')" id="mb-audit" class="flex flex-col items-center gap-1 text-slate-500 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2"/></svg><span class="text-[9px] font-bold uppercase tracking-widest">Audit</span></button>
            </nav>

            <div class="mt-auto p-4 hidden lg:block border-t border-white/5">
                <button onclick="location.reload()" class="w-full text-left text-[10px] font-black text-prestige-error uppercase tracking-widest hover:underline">Log Out System</button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col overflow-hidden pb-20 lg:pb-0">
            
            <!-- HEADER -->
            <header class="h-16 lg:h-24 bg-slate-900 lg:bg-transparent border-b border-white/5 lg:border-none flex items-center justify-between px-6 lg:px-10 no-print">
                <h2 id="v-title" class="text-lg lg:text-3xl font-black italic tracking-tighter uppercase">Dashboard</h2>
                <div id="h-tools" class="flex items-center gap-3">
                    <!-- Dinámico -->
                </div>
            </header>

            <!-- VIEWPORT -->
            <div id="viewport" class="flex-1 overflow-y-auto p-4 lg:p-10 no-scrollbar">

                <!-- DASHBOARD -->
                <div id="v-dash" class="view space-y-6 animate-in fade-in duration-500">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-6">
                        <div class="premium-card p-4 lg:p-8">
                            <p class="text-[8px] lg:text-[10px] font-bold text-slate-500 uppercase mb-2">Depósitos</p>
                            <h3 id="st-in" class="text-lg lg:text-2xl font-bold money text-white">$0.00</h3>
                        </div>
                        <div class="premium-card p-4 lg:p-8">
                            <p class="text-[8px] lg:text-[10px] font-bold text-slate-500 uppercase mb-2">Retiros</p>
                            <h3 id="st-out" class="text-lg lg:text-2xl font-bold money text-slate-400">-$0.00</h3>
                        </div>
                        <div class="premium-card p-4 lg:p-8 border-l-4 border-l-blue-600 bg-blue-600/5">
                            <p class="text-[8px] lg:text-[10px] font-black text-blue-500 uppercase mb-2">GGR Neto</p>
                            <h3 id="st-ggr" class="text-lg lg:text-2xl font-bold money text-white">$0.00</h3>
                        </div>
                        <div class="premium-card p-4 lg:p-8 border-l-4 border-l-emerald-500">
                            <p class="text-[8px] lg:text-[10px] font-bold text-slate-500 uppercase mb-2">Liquidar</p>
                            <h3 id="st-fee" class="text-lg lg:text-2xl font-bold money text-emerald-500">$0.00</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-8 premium-card p-6 lg:p-10">
                            <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6">Métrica de Nodos</h4>
                            <div class="h-64 lg:h-96">
                                <canvas id="chart-dash"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-4 premium-card p-6 lg:p-10 flex flex-col max-h-64 lg:max-h-full">
                            <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6">Eventos</h4>
                            <div id="log-list" class="flex-1 space-y-2 overflow-y-auto text-[10px] font-mono opacity-50 no-scrollbar"></div>
                        </div>
                    </div>
                </div>

                <!-- SYNC -->
                <div id="v-sync" class="view hidden h-full flex items-center justify-center animate-in zoom-in duration-300">
                    <div class="max-w-md w-full premium-card p-10 text-center border-2 border-dashed border-slate-800">
                        <div class="w-20 h-20 bg-blue-600/10 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="1.5"/></svg>
                        </div>
                        <h3 class="text-xl font-black text-white italic uppercase">Inyección de Datos</h3>
                        <p class="text-slate-500 text-xs mt-2 mb-8 uppercase tracking-widest">Master Excel Sync</p>
                        <label class="block">
                            <input type="file" id="f-input" class="hidden" onchange="app.handleFile(this.files[0])">
                            <span id="f-label" class="bg-white text-black font-black py-4 px-8 rounded-xl cursor-pointer text-xs uppercase tracking-widest shadow-xl inline-block transition-all active:scale-95">Sincronizar</span>
                        </label>
                    </div>
                </div>

                <!-- NETWORK -->
                <div id="v-net" class="view hidden space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div class="lg:col-span-4 space-y-4">
                            <div class="premium-card p-6 space-y-6 border-t-2 border-blue-600">
                                <h3 class="text-[10px] font-black uppercase tracking-widest italic">Anclar Agente</h3>
                                <div class="space-y-4">
                                    <input type="text" id="n-name" class="w-full uppercase font-bold" placeholder="ID AGENTE">
                                    <div class="flex justify-between items-center text-[10px] font-bold uppercase text-slate-500">
                                        <span>Fee</span>
                                        <span id="f-val" class="text-blue-500">20%</span>
                                    </div>
                                    <input type="range" id="n-fee" min="1" max="50" value="20" oninput="document.getElementById('f-val').innerText = this.value + '%'" class="w-full accent-blue-600 h-1 bg-slate-800 rounded-full appearance-none">
                                    <button onclick="app.addNode()" class="w-full bg-white text-black font-black py-3 rounded-xl uppercase text-[10px] tracking-widest transition-all active:scale-95">Generar Nodo</button>
                                </div>
                            </div>
                            <div id="n-list" class="space-y-2 max-h-48 lg:max-h-full overflow-y-auto no-scrollbar"></div>
                        </div>
                        <div class="lg:col-span-8 premium-card flex flex-col h-[500px] lg:h-[750px] overflow-hidden">
                            <div class="p-4 lg:p-8 bg-white/5 border-b border-white/5 flex justify-between items-center">
                                <h3 class="text-[10px] font-black uppercase tracking-widest">Mapeo de Red</h3>
                                <input type="text" id="n-search" oninput="app.renderNodes()" placeholder="Buscar..." class="w-40 lg:w-64 text-xs">
                            </div>
                            <div id="n-grid" class="flex-1 overflow-y-auto p-4 lg:p-8 grid grid-cols-1 md:grid-cols-2 gap-3 lg:gap-4 content-start no-scrollbar"></div>
                        </div>
                    </div>
                </div>

                <!-- AUDIT -->
                <div id="v-audit" class="view hidden">
                    <div id="audit-doc" class="audit-container p-6 lg:p-16 shadow-2xl relative overflow-hidden">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-end border-b-2 border-slate-100 pb-8 mb-10 gap-4">
                            <div>
                                <h1 class="text-3xl lg:text-5xl font-black italic tracking-tighter text-slate-900 leading-none">PRESTIGE STATEMENT</h1>
                                <p class="text-[9px] lg:text-[10px] font-bold text-slate-400 uppercase tracking-[0.5em] mt-2">Protocolo Institucional v3.5</p>
                            </div>
                            <div class="text-left lg:text-right space-y-2">
                                <p id="audit-id" class="text-xs font-mono font-bold text-slate-400 uppercase"></p>
                                <p id="audit-date" class="text-[9px] font-black text-blue-600 uppercase"></p>
                            </div>
                        </div>

                        <div id="audit-kpi" class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-8 mb-10 lg:mb-20"></div>
                        <div id="audit-body" class="space-y-16 lg:space-y-32"></div>

                        <div class="mt-20 lg:mt-40 pt-10 border-t border-slate-100 text-center opacity-30 italic">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[1em]">Privado • Confidencial • Red Sepybet</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        const app = {
            state: {
                nodes: [],
                data: [],
                adj: {},
                curr: 'sync',
                isLog: false,
                chart: null
            },

            init() {
                const s = localStorage.getItem('prestige_m_v3');
                if (s) {
                    const p = JSON.parse(s);
                    this.state.nodes = p.nodes || [];
                    this.state.adj = p.adj || {};
                }
            },

            authenticate() {
                const u = document.getElementById('auth-u').value.toLowerCase();
                const p = document.getElementById('auth-p').value;
                if (u === 'admin' && p === 'admin') {
                    this.state.isLog = true;
                    document.getElementById('login-gate').style.display = 'none';
                    const sh = document.getElementById('app-shell');
                    sh.classList.remove('hidden');
                    setTimeout(() => sh.style.opacity = '1', 50);
                    this.nav('sync');
                } else {
                    const err = document.getElementById('auth-error');
                    err.classList.remove('hidden');
                    setTimeout(() => err.classList.add('hidden'), 2000);
                }
            },

            nav(id) {
                if (!this.state.isLog) return;
                this.state.curr = id;
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                document.getElementById('v-' + id).classList.remove('hidden');
                
                // Active States
                document.querySelectorAll('button[id^="m-"], button[id^="mb-"]').forEach(b => b.classList.remove('nav-active'));
                document.getElementById('m-' + id).classList.add('nav-active');
                document.getElementById('mb-' + id).classList.add('nav-active');

                const ts = { dash: 'Panel Maestro', sync: 'Sync Terminal', net: 'Estructura de Red', audit: 'Auditoría Final' };
                document.getElementById('v-title').innerText = ts[id];

                const ht = document.getElementById('h-tools');
                ht.innerHTML = '';
                if (id === 'audit') {
                    ht.innerHTML = `
                        <select id="a-filt" onchange="app.renderAudit()" class="hidden lg:block text-[10px] font-black uppercase w-48"></select>
                        <button onclick="app.exportPDF()" class="bg-blue-600 text-white font-black px-4 py-2 rounded-lg text-[9px] uppercase shadow-lg shadow-blue-900/30">PDF</button>
                    `;
                    this.renderAudit();
                }

                if (id === 'dash') this.renderDash();
                if (id === 'net') this.renderNodes();
            },

            log(m, t = 'info') {
                const l = document.getElementById('log-list');
                if (!l) return;
                const tm = new Date().toLocaleTimeString('es-EC', { hour12: false });
                const cl = t === 'success' ? 'text-emerald-500' : 'text-slate-400';
                const d = document.createElement('div');
                d.className = "flex gap-3 pb-1 border-b border-white/5";
                d.innerHTML = `<span class="opacity-30 italic">${tm}</span><span class="${cl} font-bold uppercase tracking-tighter">${m}</span>`;
                l.prepend(d);
            },

            save() {
                localStorage.setItem('prestige_m_v3', JSON.stringify({
                    nodes: this.state.nodes,
                    adj: this.state.adj
                }));
            },

            handleFile(f) {
                if (!f) return;
                const r = new FileReader();
                r.onload = (e) => {
                    const d = new Uint8Array(e.target.result);
                    const w = XLSX.read(d, { type: 'array' });
                    const j = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                    this.state.data = j;
                    document.getElementById('f-label').innerText = `Matrix Ready (${j.length})`;
                    this.log(`Inyectados ${j.length} registros operativos.`, "success");
                    // AUTO REDIRECT
                    setTimeout(() => this.nav('dash'), 500);
                };
                r.readAsArrayBuffer(f);
            },

            getBalances() {
                const b = {};
                this.state.data.forEach(r => {
                    const u = r['Nombre de jugador/agente'] || r.Usuario || r.Player || 'X-ID';
                    const a = Math.abs(parseFloat(r.Monto || r.Amount || 0));
                    const ty = String(r['Tipo de operación'] || r.Type || '').toLowerCase();
                    const st = String(r['Estado'] || r.Status || '').toLowerCase();
                    if (u === 'X-ID' || st !== 'processed') return;
                    if (!b[u]) b[u] = { in: 0, out: 0 };
                    if (ty.includes('deposit') || ty.includes('ingreso')) b[u].in += a;
                    else if (ty.includes('withdrawal') || ty.includes('retiro')) b[u].out += a;
                });
                return b;
            },

            calc() {
                const b = this.getBalances();
                return this.state.nodes.map(n => {
                    let ti = 0, to = 0, ta = 0;
                    const ent = n.players.map(p => {
                        const s = b[p] || { in: 0, out: 0 };
                        const ad = parseFloat(this.state.adj[p] || 0);
                        const nt = (s.in - s.out) - ad;
                        ti += s.in; to += s.out; ta += ad;
                        return { id: p, ...s, ad, nt };
                    });
                    const gr = (ti - to) - ta;
                    const fa = gr > 0 ? (gr * (n.fee / 100)) : 0;
                    return { ...n, ent, ti, to, ta, gr, fa, h: ti > 0 ? ((gr / ti) * 100).toFixed(1) : 0 };
                });
            },

            renderDash() {
                const b = this.getBalances();
                const m = this.calc();
                const tIn = Object.values(b).reduce((a, x) => a + x.in, 0);
                const tGGR = m.reduce((a, x) => a + x.gr, 0);
                const tFee = m.reduce((a, x) => a + x.fa, 0);

                document.getElementById('st-in').innerText = `$${tIn.toLocaleString()}`;
                document.getElementById('st-out').innerText = `-$${Object.values(b).reduce((a, x) => a + x.out, 0).toLocaleString()}`;
                document.getElementById('st-ggr').innerText = `$${tGGR.toLocaleString()}`;
                document.getElementById('st-fee').innerText = `$${tFee.toLocaleString()}`;

                if (this.state.chart) this.state.chart.destroy();
                const ctx = document.getElementById('chart-dash').getContext('2d');
                this.state.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: m.map(x => x.name),
                        datasets: [{ label: 'GGR', data: m.map(x => x.gr), backgroundColor: '#3b82f6', borderRadius: 8 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            },

            addNode() {
                const n = document.getElementById('n-name').value.trim().toUpperCase();
                const f = parseInt(document.getElementById('n-fee').value);
                if (!n || this.state.nodes.some(x => x.name === n)) return;
                this.state.nodes.push({ name: n, fee: f, players: [] });
                document.getElementById('n-name').value = '';
                this.save();
                this.renderNodes();
                this.log(`Agente ${n} Generado.`, "success");
            },

            remNode(i) { this.state.nodes.splice(i, 1); this.save(); this.renderNodes(); },

            link(nIdx, p) {
                this.state.nodes.forEach(x => x.players = x.players.filter(z => z !== p));
                this.state.nodes[nIdx].players.push(p);
                this.save();
                this.renderNodes();
            },

            unlink(p) {
                this.state.nodes.forEach(x => x.players = x.players.filter(z => z !== p));
                this.save();
                this.renderNodes();
            },

            renderNodes() {
                const b = this.getBalances();
                const q = document.getElementById('n-search').value.toUpperCase();
                const pl = Object.keys(b).filter(id => id.includes(q));

                document.getElementById('n-list').innerHTML = this.state.nodes.map((n, i) => `
                    <div class="premium-card p-4 flex justify-between items-center border-l-4 border-l-blue-600">
                        <p class="text-[10px] font-black text-white italic">${n.name}</p>
                        <button onclick="app.remNode(${i})" class="text-slate-700 hover:text-prestige-error"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7" stroke-width="2"/></svg></button>
                    </div>
                `).join('');

                document.getElementById('n-grid').innerHTML = pl.map(pid => {
                    const o = this.state.nodes.find(a => a.players.includes(pid));
                    return `
                        <div class="premium-card p-5 flex flex-col gap-3 ${o ? 'bg-blue-600/5' : ''}">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-[10px] italic">${pid.charAt(0)}</div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-[11px] font-bold text-white truncate uppercase">${pid}</p>
                                    <p class="text-[8px] text-slate-500 uppercase">${o ? 'Nodo: ' + o.name : 'Libre'}</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                ${o ? `<button onclick="app.unlink('${pid}')" class="px-2 py-1 bg-prestige-error/10 text-prestige-error rounded text-[8px] font-bold uppercase">Sever</button>` : ''}
                                ${this.state.nodes.map((n, i) => o?.name !== n.name ? `<button onclick="app.link(${i}, '${pid}')" class="px-2 py-1 bg-slate-800 text-slate-400 rounded text-[8px] font-bold uppercase hover:bg-blue-600 hover:text-white">${n.name}</button>` : '').join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            updAdj(p, v) { this.state.adj[p] = v; this.save(); this.renderAudit(); },

            renderAudit() {
                const m = this.calc();
                const f = document.getElementById('a-filt')?.value || 'ALL';
                const s = document.getElementById('a-filt');
                if (s) {
                    const lv = s.value;
                    s.innerHTML = `<option value="ALL">CONSOLIDADO GLOBAL</option>` + this.state.nodes.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
                    s.value = lv || 'ALL';
                }

                const flt = f === 'ALL' ? m : m.filter(x => x.name === f);
                const gTi = m.reduce((a, b) => a + b.ti, 0);
                const gGr = m.reduce((a, b) => a + b.gr, 0);
                const gFa = m.reduce((a, b) => a + b.fa, 0);

                document.getElementById('audit-id').innerText = 'PRSTG-M' + Math.random().toString(36).substr(2, 6).toUpperCase();
                document.getElementById('audit-date').innerText = new Date().toLocaleDateString('es-EC', { dateStyle: 'long' });

                document.getElementById('audit-kpi').innerHTML = `
                    <div class="p-6 lg:p-10 border border-slate-100 rounded-3xl">
                        <p class="text-[8px] lg:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Liquidez</p>
                        <p class="text-xl lg:text-3xl font-black money-font text-slate-900">$${gTi.toLocaleString()}</p>
                    </div>
                    <div class="p-6 lg:p-10 bg-slate-900 rounded-3xl text-white">
                        <p class="text-[8px] lg:text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Utilidad Neta</p>
                        <p class="text-xl lg:text-3xl font-black money-font">$${(gGr - gFa).toLocaleString()}</p>
                    </div>
                    <div class="p-6 lg:p-10 border border-slate-100 rounded-3xl">
                        <p class="text-[8px] lg:text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Pago Agentes</p>
                        <p class="text-xl lg:text-3xl font-black money-font text-blue-600">$${gFa.toLocaleString()}</p>
                    </div>
                `;

                document.getElementById('audit-body').innerHTML = flt.map(n => `
                    <div class="space-y-6 lg:space-y-10">
                        <div class="flex justify-between items-end border-b border-slate-200 pb-6">
                            <div>
                                <h3 class="text-2xl lg:text-5xl font-black italic tracking-tighter text-slate-900 uppercase">${n.name}</h3>
                                <p class="text-[8px] lg:text-[10px] font-black bg-slate-100 px-3 py-1 rounded inline-block mt-2">Health: ${n.h}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[8px] lg:text-[10px] font-bold text-slate-400 uppercase mb-2">Comisión (${n.fee}%)</p>
                                <p class="text-2xl lg:text-6xl font-black money-font text-slate-900">$${n.fa.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-[8px] lg:text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                                    <tr>
                                        <th class="p-4">ID</th>
                                        <th class="p-4 text-center">In</th>
                                        <th class="p-4 text-center">Out</th>
                                        <th class="p-4 text-center">Adj</th>
                                        <th class="p-4 text-right">Net</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 text-[10px] lg:text-sm">
                                    ${n.ent.map(e => `
                                        <tr>
                                            <td class="p-4 font-black uppercase">${e.id}</td>
                                            <td class="p-4 text-center money-font text-slate-400">$${e.in.toLocaleString()}</td>
                                            <td class="p-4 text-center money-font text-slate-300">-$${e.out.toLocaleString()}</td>
                                            <td class="p-4 text-center no-print">
                                                <input type="number" oninput="app.updAdj('${e.id}', this.value)" value="${this.state.adj[e.id] || ''}" class="w-16 lg:w-24 text-center font-bold text-blue-600 bg-slate-50 border-none outline-none text-[10px]">
                                            </td>
                                            <td class="p-4 text-right font-black money-font text-slate-900">$${e.nt.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot class="bg-slate-50 font-black">
                                    <tr>
                                        <td colspan="4" class="p-4 text-right text-[8px] lg:text-[10px] uppercase opacity-40">Subtotal Nodo:</td>
                                        <td class="p-4 text-right text-base lg:text-2xl money-font">$${n.gr.toLocaleString()}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `).join('');
            },

            async exportPDF() {
                const doc = document.getElementById('audit-doc');
                document.querySelectorAll('.no-print').forEach(el => el.style.opacity = '0');
                const canvas = await html2canvas(doc, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
                const img = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const w = pdf.internal.pageSize.getWidth();
                const h = (canvas.height * w) / canvas.width;
                pdf.addImage(img, 'PNG', 0, 0, w, h);
                pdf.save(`AUDIT_${Date.now()}.pdf`);
                document.querySelectorAll('.no-print').forEach(el => el.style.opacity = '1');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>

